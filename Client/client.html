<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
		<link rel="stylesheet" href="style.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Test Client</title>
	</head>
	<body>
		<div class="container-fluid">
			<h1>Catan Game</h1>
			<div class="row">
				<div class="col-sm-12 col-lg-8 col-xl-6">
					<h3>Board</h3>
					<canvas id='board' onclick='receiveInput(event);' width="570" height="600" style='border: 1px solid black;'>
					</canvas>
				</div>
				<div class="col-sm-12 col-lg-4 col-xl-3">
					<h3>Other Players</h3>
					<div class="first-row" id='players'></div>
				</div>
				<div class="col-sm-12 col-xl-3">
					<h3>Console</h3>
					<div class="first-row" id='console'></div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-12 col-xl-9">
					<h3>Your Cards</h3>
					<table class='table'>
						<tbody>
							<tr>
								<td><img src='images/wood.png' style='width:40px;'/> <span id='wood-amt'>0</span></td>
								<td><img src='images/sheep.png' style='width:40px;'/> <span id='sheep-amt'>0</span></td>
								<td><img src='images/wheat.png' style='width:40px;'/> <span id='wheat-amt'>0</span></td>
								<td><img src='images/stone.png' style='width:40px;'/> <span id='stone-amt'>0</span></td>
								<td><img src='images/brick.png' style='width:40px;'/> <span id='brick-amt'>0</span></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="col-sm-12 col-xl-3">
					<h3>Actions</h3>
					<form id="pregame">
						<input name="name" type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="game-name" placeholder="Game name" autocomplete='off' />
						<br />
						<input name="submit" value="New Game" type="submit" class="btn btn-primary" />
						<input name="submit" value="Join Game" type="submit" class="btn btn-primary" />
					</form>
				</div>
			</div>
		</div>
	</body>
</html>


<script>
	
	var NONE = "";
	var GAMESTATE_BOARD = "STATE BOARD";
	var GAMESTATE_PLAYERS = "STATE PLAYERS";
	var GAMESTATE_HAND = "STATE HAND";
	var START_GAME = "GAME START";
	var JOIN_GAME = "GAME JOIN";
	var USERNAME = "USERNAME";
	var CONSOLE = "CONSOLE";
	var ROBBER = "ROBBER";
	
	var socket;
	var state = 0;
	var username = "Brandon";
	
	var expectedMessage = NONE;
	var board = {};
	
	var SHEEP_COLOR = "#a8d242";
	var WHEAT_COLOR = "#ffd300";
	var BRICK_COLOR = "#d77b42";
	var STONE_COLOR = "#797979";
	var WOOD_COLOR = "#33a642";
	var DESERT_COLOR = "#fffdb9";
	var WATER_COLOR = "#3daad6";
	var NORMAL_NUMBER_COLOR = "#000000";
	var RED_NUMBER_COLOR = "#ff0000";
	var ROBBER_COLOR = "#7f7f7f";
	var NUMBER_BG_COLOR = "#fff";
	var ALL_PORT_COLOR = "#bbb";
	var ROBBER_COLOR = "#aaa";
	
	var HEX_HEIGHT = 87;
	var HEX_WIDTH = 100;
	var HEX_SIDE = 50;
	
	var lastClick = { x: -1, y: -1 };
	
	var teams = [
		{
			color: "White",
			hexColor: "#FDF6EE"
		},
		{
			color: "Red",
			hexColor: "#CC0000"
		},
		{
			color: "Blue",
			hexColor: "#2323B2"
		},
		{
			color: "Orange",
			hexColor: "#E59400"
		}
	];
	
	$(document).ready(function (){
		socket = new WebSocket("ws://127.0.0.1:1185");
		
		socket.onmessage = function(event) {
			var setExpectedMessage = false;
			if(expectedMessage == NONE) {
				expectedMessage = event.data;
				setExpectedMessage = true;
			} else if(expectedMessage == GAMESTATE_BOARD) {
				board = JSON.parse(event.data);
				drawBoard();
			} else if(expectedMessage == GAMESTATE_PLAYERS) {
				updatePlayers(JSON.parse(event.data));
			} else if(expectedMessage == CONSOLE) {
				showMessage(event.data);
			} else if(expectedMessage == GAMESTATE_HAND) {
				updateHand(JSON.parse(event.data));
			} else if(expectedMessage == ROBBER) {
				placeRobber();
			} else {
				console.log(event.data);
			}
			
			if(!setExpectedMessage)
				expectedMessage = NONE;
		}
		
		socket.onopen = function(event) {
			socket.send(USERNAME + " " + username);
		}
	});
	
	$("#pregame").on('submit', function(e) {
		e.preventDefault();
		var data = $("#pregame :input").serializeArray();
		var val = {name: "submit", value: $("input[type=submit][clicked=true]").val()};
		data.push(val);
		
		if(data[1].value == "New Game") {
			socket.send(START_GAME + " " + data[0].value);
		} else {
			socket.send(JOIN_GAME + " " + data[0].value);
		}
	});
	
	$("form input[type=submit]").click(function() {
		$("input[type=submit]", $(this).parents("form")).removeAttr("clicked");
		$(this).attr("clicked", "true");
	});
	
	function placeRobber() {
		showMessage("You can now move the robber. The robber may not be placed on the tile that it is already located on.");
	}
	
	function receiveInput(event) {
		var rect = $("#board")[0].getBoundingClientRect();
		
		lastClick.x = event.x - rect.left;
		lastClick.y = event.y - rect.top;
	}
	
	function updateHand(hand) {
		var brick = 0;
		var stone = 0;
		var wheat = 0;
		var sheep = 0;
		var wood = 0;
		
		for(var i = 0; i<hand.length; i++) {
			var card = hand[i];
			if(card == "Brick")
				brick++;
			else if(card == "Stone")
				stone++;
			else if(card == "Wheat")
				wheat++;
			else if(card == "Sheep")
				sheep++;
			else
				wood++;
		}
		
		$("#wood-amt").html(wood);
		$("#sheep-amt").html(sheep);
		$("#wheat-amt").html(wheat);
		$("#stone-amt").html(stone);
		$("#brick-amt").html(brick);
	}
	
	function updatePlayers(players) {
		var playerList = "";
		for(var i = 0; i < players.length; i++) {
			var player = players[i];
			playerList += "<div class='card'>"
			playerList += "<div class='card-body'>"
			playerList += "<h4 class='card-title'>" + player.name + "</h4>";
			playerList += "<h6 class='card-subtitle mb-2 text-muted'>" + teams[player.team].color + "</h6>";
			playerList += "<div>Cards: " + player.cards + "</div>";
			playerList += "<div>Dev Cards: " + player.devCards + "</div>";
			playerList += "<div>Played Dev Cards: " + player.playedDevCards + "</div>";
			playerList += "</div></div><br />";
		}
		$("#players").html(playerList);
	}
	
	function showMessage(message) {
		$("#console").append("<div>"+message+"</div>");
		$("#console").stop().animate({scrollTop: $("#console")[0].scrollHeight}, 1000);
	}
	
	function drawBoard() {
		console.log(board);
		var canvas = $("#board")[0].getContext('2d');
		canvas.fillStyle = WATER_COLOR;
		canvas.fillRect(0, 0, 600, 600);
		var xOffsetGlobal = $("#board")[0].width / 2 - 4 * HEX_WIDTH / 2;
		var yOffsetGlobal = $("#board")[0].height / 2 - 5 * HEX_HEIGHT / 2;
	
		drawHexes(xOffsetGlobal, yOffsetGlobal, canvas, board.tiles);
		drawLinks(xOffsetGlobal, yOffsetGlobal, canvas, board.links);
		drawPorts(xOffsetGlobal, yOffsetGlobal, canvas, board.ports);
		drawRobber(xOffsetGlobal, yOffsetGlobal, canvas, board.robber);
	}
	
	function drawHexes(xOffsetGlobal, yOffsetGlobal, canvas, tiles) {
		for(var i = 0; i < tiles.length; i++) {
			for(var j = 0; j < tiles[i].length; j++) {
				if(tiles[i][j] != null) {
					if(tiles[i][j].resource == "Wheat") {
						canvas.fillStyle = WHEAT_COLOR;
					} else if(tiles[i][j].resource == "Sheep") {
						canvas.fillStyle = SHEEP_COLOR;
					} else if(tiles[i][j].resource == "Stone") {
						canvas.fillStyle = STONE_COLOR;
					} else if(tiles[i][j].resource == "Brick") {
						canvas.fillStyle = BRICK_COLOR;
					} else if(tiles[i][j].resource == "Wood") {
						canvas.fillStyle = WOOD_COLOR;
					} else if(tiles[i][j].resource == "None") {
						canvas.fillStyle = DESERT_COLOR;
					} 
					var xOffset = j * HEX_WIDTH * 3 / 4;
					var yOffset = i * HEX_HEIGHT - j * HEX_HEIGHT / 2;
					
					canvas.beginPath();
					var x = xOffset + xOffsetGlobal + HEX_WIDTH / 4;
					var y = yOffset + yOffsetGlobal;
					canvas.moveTo(x, y);
					x += HEX_WIDTH / 2;
					canvas.lineTo(x, y);
					x += HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 4;
					y -= HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					
					canvas.closePath();
					canvas.fill();
					
					canvas.strokeStyle = "#000";
					canvas.beginPath();
					x = xOffset + xOffsetGlobal + HEX_WIDTH / 4;
					y = yOffset + yOffsetGlobal;
					canvas.moveTo(x, y);
					x += HEX_WIDTH / 2;
					canvas.lineTo(x, y);
					x += HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 2;
					canvas.lineTo(x, y);
					x -= HEX_WIDTH / 4;
					y -= HEX_HEIGHT / 2;
					canvas.lineTo(x, y);
					
					canvas.closePath();
					canvas.stroke();
					
					drawSpaces(xOffsetGlobal, yOffsetGlobal, canvas, tiles[i][j], j, i);
					
					if(tiles[i][j].resource != "None") {
						var horizontalOffset = xOffset + xOffsetGlobal + HEX_WIDTH / 2;
						var verticalOffset = yOffset + yOffsetGlobal + HEX_HEIGHT / 2
						
						canvas.fillStyle = NUMBER_BG_COLOR;
						canvas.beginPath();
						canvas.arc(horizontalOffset, verticalOffset, 20, 0, 2 * Math.PI);
						canvas.fill();
						
						
						canvas.font = "20px Arial";
						if(tiles[i][j].roll == 6 || tiles[i][j].roll == 8) {
							canvas.fillStyle = RED_NUMBER_COLOR;
						} else {
							canvas.fillStyle = NORMAL_NUMBER_COLOR;
						}
						var textWidth = canvas.measureText(tiles[i][j].roll).width;
						canvas.fillText(tiles[i][j].roll, horizontalOffset - textWidth / 2, verticalOffset + 7);
					}
				}
			}
		}
	}
	
	function drawSpaces(xOffsetGlobal, yOffsetGlobal, canvas, tile, column, diagonal) {
		var spaces = tile.spaces;
		for(var i = 0; i < spaces.length; i++) {
			var space = spaces[i];
			if(space.building != null) {
				var x = xOffsetGlobal + column * HEX_WIDTH * 3 / 4 + HEX_WIDTH / 4;
				var y = yOffsetGlobal + diagonal * HEX_HEIGHT - column * HEX_HEIGHT / 2;
				
				if(i >= 1) {
					x += HEX_WIDTH / 2;
				}
				if(i >= 2) {
					x += HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
				}
				if(i >= 3) {
					x -= HEX_WIDTH / 4;
					y += HEX_HEIGHT / 2;
				}
				if(i >= 4) {
					x -= HEX_WIDTH / 2;
				}
				if(i >= 5) {
					x -= HEX_WIDTH / 4;
					y -= HEX_HEIGHT / 2;
				}
				canvas.fillStyle = "#000";
				canvas.beginPath();
				canvas.arc(x, y, 10, 0, 2 * Math.PI);
				canvas.closePath();
				canvas.fill();
			}
		}
	}
	
	function drawLinks(xOffsetGlobal, yOffsetGlobal, canvas, links) {
		for(var i = 0; i < links.length; i++) {
			var x = [];
			var y = [];
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4 + HEX_WIDTH / 4);
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4 + HEX_WIDTH * 3 / 4);
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4 + HEX_WIDTH);
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4 + HEX_WIDTH * 3 / 4);
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4 + HEX_WIDTH / 4);
			x.push(xOffsetGlobal + links[i].column * HEX_WIDTH * 3 / 4);
			
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2);
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2);
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2 + HEX_HEIGHT / 2);
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2 + HEX_HEIGHT);
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2 + HEX_HEIGHT);
			y.push(yOffsetGlobal + links[i].diagonal * HEX_HEIGHT - links[i].column * HEX_HEIGHT / 2 + HEX_HEIGHT / 2);
			
			var idx1 = links[i].position - 1;
			if(idx1 < 0) idx1 += 6;
			var idx2 = links[i].position;
			
			if(links[i].road != -1) {
				canvas.lineWidth = 5;
				canvas.beginPath();
				canvas.moveTo(x[idx1], y[idx1]);
				canvas.lineTo(x[idx2], y[idx2]);
				canvas.closePath();
				canvas.stroke();
			}
		}
	}

	function drawPorts(xOffsetGlobal, yOffsetGlobal, canvas, ports) {
		for(var i = 0; i < ports.length; i++) {
			var port = ports[i];
			
			if(port != null && port.link != null) {
				var lin = port.link;
				var x = [];
				var y = [];
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4 + HEX_WIDTH / 4);
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4 + HEX_WIDTH * 3 / 4);
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4 + HEX_WIDTH);
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4 + HEX_WIDTH * 3 / 4);
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4 + HEX_WIDTH / 4);
				x.push(xOffsetGlobal + lin.column * HEX_WIDTH * 3 / 4);
				
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2);
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2);
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2 + HEX_HEIGHT / 2);
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2 + HEX_HEIGHT);
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2 + HEX_HEIGHT);
				y.push(yOffsetGlobal + lin.diagonal * HEX_HEIGHT - lin.column * HEX_HEIGHT / 2 + HEX_HEIGHT / 2);
				
				var idx1 = lin.position - 1;
				if(idx1 < 0) idx1 += 6;
				var idx2 = lin.position;
				
				var mX = (x[idx1] + x[idx2]) / 2;
				var mY = (y[idx1] + y[idx2]) / 2;
				var slope = -(x[idx1] - x[idx2]) / (y[idx1] - y[idx2]);
				var dx = HEX_SIDE / Math.sqrt(1 + slope * slope);
				if(lin.position == 5 || lin.position == 0) {
					dx *= -1;
				}
				var dy = slope * dx;
				
				var portX = mX + dx;
				var portY = mY + dy;
				if(slope == Infinity) {
					portX = mX;
					portY = mY - HEX_SIDE;
				} else if(slope == -1 * Infinity) {
					portX = mX;
					portY = mY + HEX_SIDE;
				}
				
				canvas.beginPath();
				canvas.moveTo(x[idx1], y[idx1]);
				canvas.lineTo(portX, portY);
				canvas.moveTo(x[idx1], y[idx1]);
				canvas.closePath();
				canvas.stroke();
				
				canvas.beginPath();
				canvas.moveTo(x[idx2], y[idx2]);
				canvas.lineTo(portX, portY);
				canvas.moveTo(x[idx2], y[idx2]);
				canvas.closePath();
				canvas.stroke();
				
				if(port.type == "Wheat") {
					canvas.fillStyle = WHEAT_COLOR;
				} else if(port.type == "Sheep") {
					canvas.fillStyle = SHEEP_COLOR;
				} else if(port.type == "Stone") {
					canvas.fillStyle = STONE_COLOR;
				} else if(port.type == "Brick") {
					canvas.fillStyle = BRICK_COLOR;
				} else if(port.type == "Wood") {
					canvas.fillStyle = WOOD_COLOR;
				} else if(port.type == "All") {
					canvas.fillStyle = ALL_PORT_COLOR;
				}
				canvas.beginPath();
				canvas.moveTo(portX, portY);
				canvas.arc(portX, portY, 10, 0, Math.PI * 2);
				canvas.closePath();
				canvas.fill();
				canvas.moveTo(portX, portY);
				canvas.beginPath();
				canvas.arc(portX, portY, 10, 0, Math.PI * 2);
				canvas.closePath();
				canvas.stroke();
			}
		}
	}

	function drawRobber(xOffsetGlobal, yOffsetGlobal, canvas, robber) {
		var xOffset = robber.column * HEX_WIDTH * 3 / 4;
		var yOffset = robber.diagonal * HEX_HEIGHT - robber.column * HEX_HEIGHT / 2;
		var x = xOffset + xOffsetGlobal + HEX_WIDTH / 2;
		var y = yOffset + yOffsetGlobal + HEX_HEIGHT / 2;
		
		canvas.fillStyle = ROBBER_COLOR;
		canvas.beginPath();
		canvas.arc(x, y, 20, 0, Math.PI * 2);
		canvas.closePath();
		canvas.fill();
	}
</script>
