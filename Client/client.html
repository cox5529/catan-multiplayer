<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
		<link rel="stylesheet" href="style.css" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
		<script src="constantsCatan.js"></script>
		<script src="drawCatan.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<title>Test Client</title>
	</head>
	<body>
		<div class="container-fluid">
			<div class='row'>
				<div class='col-xl-3 col-sm-12'>
					<div class='card'>
						<div id='player-0' class='card-body'>
							<h4 class="card-title">AI Player 0</h4>
							<h6 class="card-subtitle mb-2 text-muted">White</h6>
							<div>Cards: 0</div><div>Dev Cards: 0</div>
							<div>Played Dev Cards: </div>
						</div>
					</div>
				</div>
				<div class='col-xl-3 col-sm-12 offset-xl-6'>
					<div class='card'>
						<div id='player-1' class='card-body'>
							<h4 class="card-title">AI Player 1</h4>
							<h6 class="card-subtitle mb-2 text-muted">White</h6>
							<div>Cards: 0</div><div>Dev Cards: 0</div>
							<div>Played Dev Cards: </div>
						</div>
					</div>
				</div>
			</div>
			<div class='row'>
				<div class='col-xl-3 col-sm-12'>
					<h3>Console</h3>
					<div class="first-row" id='console'></div>
				</div>
				<div class='col-xl-6 col-sm-12 text-center'>
					<canvas id='board' onclick='receiveInput(event);' width="570" height="580" style='border: 1px solid black;'>
					</canvas>
				</div>
				<div class='col-xl-3 col-sm-12'>
					<h3>Actions</h3>
					<form id="form">
						<input name="name" type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="game-name" placeholder="Game name" autocomplete='off' />
						<br />
						<input name="submit" value="New Game" type="submit" class="btn btn-primary" />
						<input name="submit" value="Join Game" type="submit" class="btn btn-primary" />
					</form>
				</div>
			</div>
			<div class='row align-items-end'>
				<div class='col-xl-3 col-sm-12'>
					<div class='card'>
						<div id='player-3' class='card-body'>
							<h4 class="card-title">AI Player 3</h4>
							<h6 class="card-subtitle mb-2 text-muted">White</h6>
							<div>Cards: 0</div><div>Dev Cards: 0</div>
							<div>Played Dev Cards: </div>
						</div>
					</div>
				</div>
				<div class='col-xl-6 col-sm-12'>
					<table class='table'>
						<tbody>
							<tr>
								<td><img src='images/wood.png' class='resource-icon'/> <span id='wood-amt'>0</span></td>
								<td><img src='images/sheep.png' class='resource-icon'/> <span id='sheep-amt'>0</span></td>
								<td><img src='images/wheat.png' class='resource-icon'/> <span id='wheat-amt'>0</span></td>
								<td><img src='images/stone.png' class='resource-icon'/> <span id='stone-amt'>0</span></td>
								<td><img src='images/brick.png' class='resource-icon'/> <span id='brick-amt'>0</span></td>
							</tr>
							<tr>
								<td>Monopolies: <span id='monopoly-amt'>0</span></td>
								<td>Years of plenty: <span id='yop-amt'>0</span></td>
								<td>Road buildings: <span id='rb-amt'>0</span></td>
								<td>Knights: <span id='knight-amt'>0</span></td>
								<td>Victory points: <span id='vp-amt'>0</span></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class='col-xl-3 col-sm-12'>
					<div class='card'>
						<div id='player-2' class='card-body'>
							<h4 class="card-title">AI Player 2</h4>
							<h6 class="card-subtitle mb-2 text-muted">White</h6>
							<div>Cards: 0</div><div>Dev Cards: 0</div>
							<div>Played Dev Cards: </div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>


<script>
	var socket;
	var state = 0;
	var username = "Brandon";
	var team = 0;
	
	var expectedMessage = NONE;
	var board = {};
	var hexes = [];
	var devCards = [];
	
	var xOffsetGlobal = 0;
	var yOffsetGlobal = 0;
	
	var lastClick = { x: -1, y: -1 };
	var settlements = [];
	var roads = [];
	
	var onInput = null;
	var inputArg = null;
	
	$(document).ready(function (){
		socket = new WebSocket("ws://127.0.0.1:1185");
		
		socket.onmessage = function(event) {
			var setExpectedMessage = false;
			if(expectedMessage == NONE) {
				expectedMessage = event.data;
				setExpectedMessage = true;
			} else if(expectedMessage == GAMESTATE_BOARD) {
				board = JSON.parse(event.data);
				drawBoard();
			} else if(expectedMessage == GAMESTATE_PLAYERS) {
				updatePlayers(JSON.parse(event.data));
			} else if(expectedMessage == CONSOLE) {
				showMessage(event.data);
			} else if(expectedMessage == GAMESTATE_HAND) {
				updateHand(JSON.parse(event.data));
			} else if(expectedMessage == ROBBER) {
				placeRobber(JSON.parse(event.data));
			} else if(expectedMessage == TURN) {
				doTurn();
			} else if(expectedMessage == GAMESTATE_DEV_CARDS) {
				devCards = JSON.parse(event.data);
				updateDevCards(devCards);
			} else if(expectedMessage == PLACE) {
				placeInitial();
			} else if(expectedMessage == TEAM) {
				team = parseInt(event.data);
			} else {
				console.log(event.data);
			}
			
			if(!setExpectedMessage)
				expectedMessage = NONE;
		}
		
		socket.onopen = function(event) {
			socket.send(USERNAME + " " + username);
		}
	
		var onsubmit = function(e) {
			e.preventDefault();
			var data = $("#form :input").serializeArray();
			var val = {name: "submit", value: $("input[type=submit][clicked=true]").val()};
			data.push(val);
			
			if(data[1].value == "New Game") {
				socket.send(START_GAME + " " + data[0].value);
			} else {
				socket.send(JOIN_GAME + " " + data[0].value);
			}
			$("#form").html("");
		};
		
		updateForm(null, onsubmit);
		
		xOffsetGlobal = $("#board")[0].width / 2 - 4 * HEX_WIDTH / 2;
		yOffsetGlobal = $("#board")[0].height / 2 - 5 * HEX_HEIGHT / 2;
	});
	
	function doTurn() {
		var devCards = countDevCards();
		var html = "";
		html += "<table class='table'><thead><tr><th>Action</th><th>Requirements</th></tr></thead><tbody>";
		html += "<tr>";
		html += "	<td><input type='submit' class='btn btn-primary' name='action' value='Build Settlement' /></td>";
		html += "	<td><img src='images/brick.png' class='resource-icon'/><img src='images/wheat.png' class='resource-icon'/><img src='images/wood.png' class='resource-icon'/><img src='images/sheep.png' class='resource-icon'/></td>";
		html += "</tr>";
		html += "<tr>";
		html += "	<td><input type='submit' class='btn btn-primary' name='action' value='Build City' /></td>";
		html += "	<td><img src='images/stone.png' class='resource-icon'/><img src='images/stone.png' class='resource-icon'/><img src='images/stone.png' class='resource-icon'/><img src='images/wheat.png' class='resource-icon'/><img src='images/wheat.png' class='resource-icon'/></td>";
		html += "</tr>";
		html += "<tr>";
		html += "	<td><input type='submit' class='btn btn-primary' name='action' value='Build Road' /></td>";
		html += "	<td><img src='images/brick.png' class='resource-icon'/><img src='images/wood.png' class='resource-icon'/></td>";
		html += "</tr>";
		html += "<tr>";
		html += "	<td><input type='submit' class='btn btn-primary' name='action' value='Buy Development Card' /></td>";
		html += "	<td><img src='images/stone.png' class='resource-icon'/><img src='images/wheat.png' class='resource-icon'/><img src='images/sheep.png' class='resource-icon'/></td>";
		html += "</tr>";
		html += "<tr><td colspan='2'>";
		if(devCards.knight.playable > 0)
			html += "	<input type='submit' class='btn btn-primary' name='action' value='Play Knight' /> ";
		if(devCards.monopoly.playable > 0)
			html += "	<input type='submit' class='btn btn-primary' name='action' value='Play Monopoly' /> ";
		if(devCards.yop.playable > 0)
			html += "	<input type='submit' class='btn btn-primary' name='action' value='Play Year of Plenty' /> ";
		if(devCards.rb.playable > 0)
			html += "	<input type='submit' class='btn btn-primary' name='action' value='Play Road Building' /> ";
		html += "</td></tr>";
		html += "<tr><td colspan='2'>";
		html += "	<input type='submit' class='btn btn-primary' name='action' value='End Turn' /> ";
		html += "</td></tr>";
		html += "</tbody></table>";
		
		var onsubmit = function(e) {
			e.preventDefault();
			var val = $("input[type=submit][clicked=true]").val();
			if(val == "Build Settlement") {
				buildSettlement();
			} else if(val == "Build City") {
				buildCity();
			} else if(val == "Build Road") {
				buildRoad();
			} else if(val == "Buy Development Card") {
				socket.send(RESPONSE + " " + DEV_CARD);
			} else if(val == "Play Knight") {
				socket.send(RESPONSE + " " + KNIGHT);
			} else if(val == "Play Monopoly") {
				doMonopoly();
			} else if(val == "Play Year of Plenty") {
				
			} else if(val == "Play Road Building") {
				
			} else if(val == "End Turn") {
				socket.send(RESPONSE + " " + TURN);
				updateForm("", null);
			}
		};
		
		updateForm(html, onsubmit);
	}
	
	function placeInitial() {
		showMessage("You may now place a settlement. Click where you would like to place your settlement.");
		inputArg = board;
		drawBoard(1, false, null, true);
		onInput = function(x, y) {
			var pos = calculateSpaceClicked(x, y);
			if(pos != null && isValidSettlement({x: x, y: y}, true)) {
				socket.send(RESPONSE + " " + PLACE + " " + SETTLEMENT + " " + pos.hex.diagonal + " " + pos.hex.column + " " + pos.space);
				showMessage("You may now place a road. Click where you would like to place your road.");
				inputArg = board;
				drawBoard(0, true, pos);
				onInput = function(x, y) {
					var pos = calculateLinkClicked(x, y);
					if(pos != null) {
						drawBoard();
						socket.send(RESPONSE + " " + PLACE + " " + ROAD + " " + pos.hex.diagonal + " " + pos.hex.column + " " + pos.link);
						onInput = null;
					}
				};
			}
		};
	}
	
	function buildCity() {
		showMessage("You may now place a city. Click where you would like to place your city.");
		inputArg = board;
		drawBoard(2);
		onInput = function(x, y) {
			var pos = calculateSpaceClicked(x, y);
			if(pos != null) {
				drawBoard();
				socket.send(RESPONSE + " " + CITY + " " + pos.hex.diagonal + " " + pos.hex.column + " " + pos.space);
				onInput = null;
			}
		}
	}
	
	function buildSettlement() {
		showMessage("You may now place a settlement. Click where you would like to place your settlement.");
		inputArg = board;
		drawBoard(1);
		onInput = function(x, y) {
			var pos = calculateSpaceClicked(x, y);
			if(pos != null) {
				drawBoard();
				socket.send(RESPONSE + " " + SETTLEMENT + " " + pos.hex.diagonal + " " + pos.hex.column + " " + pos.space);
				onInput = null;
			}
		};
	}
	
	function buildRoad() {
		showMessage("You may now place a road. Click where you would like to place your road.");
		inputArg = board;
		drawBoard(0, true);
		onInput = function(x, y) {
			var pos = calculateLinkClicked(x, y);
			if(pos != null) {
				drawBoard();
				socket.send(RESPONSE + " " + ROAD + " " + pos.hex.diagonal + " " + pos.hex.column + " " + pos.link);
				onInput = null;
			}
		};
	}
	
	function isValidSettlement(position, init) {
		var twoSpaces = true;
		var connected = false;
		for(var i = 0; i < settlements.length; i++) {
			var settlement = settlements[i];
			var d = dist(position.x, position.y, settlement.x, settlement.y);
			if(d <= HEX_SIDE + 20) {
				return false;
			}
		}
		if(!init) {
			for(var i = 0; i < roads.length; i++) {
				var road = roads[i];
				if(road.team == team) {
					var d = dist(position.x, position.y, road.start.x, road.start.y);
					if(d <= 10) {
						connected = true;
						break;
					}
					d = dist(position.x, position.y, road.stop.x, road.stop.y);
					if(d <= 10) {
						connected = true;
						break;
					}
				}
			}
		}
		return twoSpaces && (connected || init);
	}
	
	function isValidCity(position) {
		for(var i = 0; i < settlements.length; i++) {
			var settlement = settlements[i];
			if(settlement.team == team) {
				var d = dist(position.x, position.y, settlement.x, settlement.y);
				if(d <= 20) {
					return true;
				}
			}
		}
		return false;
	}
	
	function isValidRoad(start, stop) {
		for(var i = 0; i < roads.length; i++) {
			road = roads[i];
			if(road.team == team) {
				var d = dist(start.x, start.y, road.start.x, road.start.y);
				if(d <= 10) {
					return true;
				}
				d = dist(start.x, start.y, road.stop.x, road.stop.y);
				if(d <= 10) {
					return true;
				}
				d = dist(stop.x, stop.y, road.start.x, road.start.y);
				if(d <= 10) {
					return true;
				}
				d = dist(stop.x, stop.y, road.stop.x, road.stop.y);
				if(d <= 10) {
					return true;
				}
			}
		}
		for(var i = 0; i < settlements.length; i++) {
			var settlement = settlements[i];
			var d = dist(start.x, start.y, settlement.x, settlement.y);
			if(d <= 2 && settlement.team == team) 
				return true;
			d = dist(stop.x, stop.y, settlement.x, settlement.y);
			if(d <= 2 && settlement.team == team) 
				return true; 
		}
		return false;
	}
	
	function doMonopoly() {
		var html = "<p>Which resource would you like to monopolize?</p>";
		html += "<input type='image' src='images/wood.png' value='wood' class='resource-icon-lg' /> ";
		html += "<input type='image' src='images/sheep.png' value='sheep' class='resource-icon-lg' /> ";
		html += "<input type='image' src='images/wheat.png' value='wheat' class='resource-icon-lg' /> ";
		html += "<input type='image' src='images/stone.png' value='stone' class='resource-icon-lg' /> ";
		html += "<input type='image' src='images/brick.png' value='brick' class='resource-icon-lg' /> ";
		html += "<br /><input type='submit' class='btn btn-primary' value='Cancel' />";
		var onsubmit = function(e) {
			e.preventDefault();
			var val = $("input[type=image][clicked=true]").val();
			var cancel = ($("input[type=submit][clicked=true]").val() != null);
			
			if(!cancel) {
				socket.send(RESPONSE + " " + MONOPOLY + " " + val);
			}
			doTurn();
		};
		
		updateForm(html, onsubmit);
	}
	
	function updateForm(html, onsubmit) {
		if(html != null) {
			$("#form").html(html);
		}
		$("#form input[type=submit]").click(function() {
			$("input[type=submit]", $(this).parents("form")).removeAttr("clicked");
			$(this).attr("clicked", "true");
		});
		$("#form input[type=image]").click(function() {
			$("input[type=image]", $(this).parents("form")).removeAttr("clicked");
			$(this).attr("clicked", "true");
		});
		$("#form").unbind('submit');
		$("#form").on('submit', onsubmit);
	}
	
	function placeRobber(board) {
		showMessage("You can now move the robber. The robber may not be placed on the tile that it is already located on.");
		inputArg = board;
		onInput = function(x, y) {
			coordinate = calculateHexClicked(x, y);
			var board = inputArg;
			if(coordinate.diagonal == board.robber.diagonal && coordinate.column == board.robber.column) {
				showMessage("You must place the robber on a tile that is not already located on.");
			} else if(board.tiles[coordinate.diagonal][coordinate.column] == null) {
				showMessage("You must place the robber on a valid tile.");
			} else {
				socket.send(RESPONSE + " " + coordinate.diagonal + " " + coordinate.column);
				onInput = null;
			}
		};
	}
	
	function receiveInput(event) {
		var rect = $("#board")[0].getBoundingClientRect();
		
		lastClick.x = event.x - rect.left;
		lastClick.y = event.y - rect.top;
		
		if(onInput != null) {
			onInput(lastClick.x, lastClick.y);
		}
	}
	
	function calculateHexClicked(x, y) {
		for(var i = 0; i < hexes.length; i++) {
			for(var j = 0; j < hexes[i].length; j++) {
				var hex = hexes[i][j];
				if(hex != null) {
					if(hex.first[0] <= x && hex.first[1] <= y && hex.last[0] > x && hex.last[1] > y) {
						if(isPointInPolygon(x, y, hex.points)) {
							return hex;
						}
					}
				}
			}
		}
		return null;
	}
	
	function isPointInPolygon(x, y, polygon) {
		var count = 0;
		for(var i = 0; i < polygon.length - 1; i++) {
			count += doSegmentsIntersect([[x, y], [99999, 99999]], [polygon[i], polygon[i + 1]]);
		}
		count += doSegmentsIntersect([[x, y], [99999, 99999]], [polygon[5], polygon[0]]);
		return (count % 2 == 1);
	}
	
	function doSegmentsIntersect(a, b) {
		var x1 = a[0][0];
		var y1 = a[0][1];
		var x2 = a[1][0];
		var y2 = a[1][1];
		var x3 = b[0][0];
		var y3 = b[0][1];
		var x4 = b[1][0];
		var y4 = b[1][1];

		var m1 = (y1 - y2) / (x1 - x2);
		var m2 = (y3 - y4) / (x3 - x4);
		
		var x = (m1 * x1 - y1 - m2 * x3 + y3) / (m1 - m2);
		if((x1 <= x && x <= x2) || (x2 <= x && x <= x1)) {
			if((x3 <= x && x <= x4) || (x4 <= x && x <= x3)) {
				return 1;
			}
		}
		return 0;
	}
	
	function dist(x1, y1, x2, y2) {
		return Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
	}
	
	function calculateSpaceClicked(x, y) {
		var hex = calculateHexClicked(x, y);
		if(hex != null) {
			var diag = hex.diagonal;
			var col = hex.column;
			
			for(var i = 0; i < hex.points.length; i++) {
				var point = hex.points[i];
				var d = dist(x, y, point[0], point[1]);
				if(d < 15) {
					return {hex: hex, space: i};
				}
			}
		}
		return null;
	}
	
	function calculateLinkClicked(x, y) {
		var hex = calculateHexClicked(x, y);
		if(hex != null) {
			for(var i = 1; i < hex.points.length; i++) {
				if(linePointDistance(x, y, hex.points[i - 1], hex.points[i]) < 10) {
					return {hex: hex, link: i};
				}
			}
			if(linePointDistance(x, y, hex.points[5], hex.points[0]) < 10) {
				return {hex: hex, link: 0};
			}
		}
		return null;
	}
	
	function linePointDistance(x, y, p1, p2) {
		var x1 = p1[0];
		var y1 = p1[1];
		var x2 = p2[0];
		var y2 = p2[1];
		
		return Math.abs(x * (y2 - y1) - y * (x2 - x1) + x2 * y1 - y2 * x1)/ dist(x1, y1, x2, y2);
	}

	function countDevCards() {
		var monopoly = {playable: 0, unplayable: 0};
		var yop = {playable: 0, unplayable: 0};
		var rb = {playable: 0, unplayable: 0};
		var knight = {playable: 0, unplayable: 0};
		var vp = {playable: 0, unplayable: 0};
		
		for(var i = 0; i < devCards.length; i++) {
			var card = devCards[i];
			if(card.name == "Monopoly") {
				if(card.gainedThisTurn) {
					monopoly.unplayable++;
				} else {
					monopoly.playable++;
				}
			} else if(card.name == "Knight") {
				if(card.gainedThisTurn) {
					knight.unplayable++;
				} else {
					knight.playable++;
				}
			} else if(card.name == "Year of plenty") {
				if(card.gainedThisTurn) {
					yop.unplayable++;
				} else {
					yop.playable++;
				}
			} else if(card.name == "Road building") {
				if(card.gainedThisTurn) {
					rb.unplayable++;
				} else {
					rb.playable++;
				}
			} else {
				vp.playable++;
			}
		}
		return {monopoly: monopoly, yop: yop, rb: rb, knight: knight, vp: vp};
	}
	
	function updateDevCards() {
		var cards = countDevCards();
		
		$("#monopoly-amt").html(getCardString(cards.monopoly));
		$("#yop-amt").html(getCardString(cards.yop));
		$("#rb-amt").html(getCardString(cards.rb));
		$("#knight-amt").html(getCardString(cards.knight));
		$("#vp-amt").html(getCardString(cards.vp));
	}
	
	function getCardString(card) {
		var re = "" + card.playable;
		if(card.unplayable != 0) {
			re += " (" + card.unplayable + ")";
		}
		return re;
	}
	
	function updateHand(hand) {		
		$("#wood-amt").html(hand.wood);
		$("#sheep-amt").html(hand.sheep);
		$("#wheat-amt").html(hand.wheat);
		$("#stone-amt").html(hand.stone);
		$("#brick-amt").html(hand.brick);
	}
	
	function updatePlayers(players) {
		for(var i = 0; i < players.length; i++) {
			var player = players[i];
			var playerList = "";
			playerList += "<h4 class='card-title'>" + player.name + "</h4>";
			playerList += "<h6 class='card-subtitle mb-2 text-muted'>" + teams[player.team].color + "</h6>";
			playerList += "<div>Cards: " + player.cards + "</div>";
			playerList += "<div>Dev Cards: " + player.devCards + "</div>";
			playerList += "<div>Played Dev Cards: " + player.playedDevCards + "</div>";
			$("#player-" + i).html(playerList);
		}
	}
	
	function showMessage(message) {
		$("#console").append("<div>"+message+"</div><br / >");
		$("#console").stop().animate({scrollTop: $("#console")[0].scrollHeight}, 1000);
		console.log(message);
	}
</script>
